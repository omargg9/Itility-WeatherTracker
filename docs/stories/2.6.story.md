# Story 2.6: Location Switching & State Management

**Epic:** Epic 2 - Enhanced Forecast & Location Features  
**Story ID:** 2.6  
**Created:** 2025-12-03  
**Status:** Draft  

---

## Story

As a **user**,  
I want **seamless switching between different locations**,  
so that **I can view weather for multiple places without confusion**.

---

## Acceptance Criteria

1. App state properly manages current selected location
2. All weather displays (current, hourly, 5-day) update when location changes
3. Location name prominently displayed in header or main view
4. Smooth transitions when switching locations (Framer Motion)
5. TanStack Query cache efficiently handles multiple location data
6. Current location persisted in localStorage (remember last viewed)
7. URL updates to reflect current location (shareable links)
8. Browser back/forward buttons work correctly with location changes
9. No data flash or jank when switching locations
10. Loading states coordinate across all weather components during location change

---

## Tasks

### Task 1: Create Location Context
- Create React Context for location state management
- Store current location: `{ lat, lon, name, country }`
- Provide `setLocation` function to update state
- Wrap app with LocationProvider
- Create `useLocation` hook for consuming context

### Task 2: Implement URL Routing for Locations
- Update React Router to support location params
- Route pattern: `/weather/:lat/:lon` or `/weather/:citySlug`
- Update URL when location changes
- Parse URL params on page load to restore location
- Ensure browser back/forward buttons work correctly

### Task 3: Connect All Weather Components to Location State
- Update WeatherDisplay to use location from context
- Update ForecastDisplay to use location from context
- Update HourlyForecast to use location from context
- All components re-fetch data when location changes
- Use TanStack Query's automatic refetch on key change

### Task 4: Persist Last Viewed Location
- Save current location to localStorage on change
- Key: `last-viewed-location`
- Include lat, lon, name, timestamp
- On app load, check for saved location
- Auto-load last viewed location if available

### Task 5: Add Location Display in Header
- Show current location name prominently
- Format: "San Francisco, CA" or "New York, NY"
- Make clickable to open search or location selector
- Update when location changes

### Task 6: Implement Smooth Transitions
- Use Framer Motion AnimatePresence for location changes
- Fade out old data, fade in new data
- Coordinate loading states across components
- Prevent layout shift during transitions
- Ensure 60fps smooth animations

### Task 7: Handle TanStack Query Caching
- Configure query keys to include location coordinates
- Cache persists data for recently viewed locations
- Implement cache invalidation when needed
- Test switching between multiple locations quickly

### Task 8: Create Tests
- Test location context state management
- Test URL routing and params
- Test localStorage persistence
- Test component updates on location change
- Test browser back/forward navigation
- Achieve 90%+ coverage

---

## Dev Notes

**Context Pattern:** Use React Context API for global location state

**URL Structure:** `/weather?lat=40.7128&lon=-74.0060` or `/weather/new-york-ny`

**Query Keys:** `['weather', lat, lon]`, `['forecast', lat, lon]` - automatic refetch on change

**LocalStorage:** Save location on every change, load on app mount

---

## Testing

Test location state management, URL routing, localStorage persistence, component coordination, and transition smoothness.

**Coverage:** 90%+

---

## Change Log

| Date | Author | Change |
|------|--------|--------|
| 2025-12-03 | SM (Bob) | Story created from PRD Epic 2, Story 2.6 |

---

## Dev Agent Record

**Date Started:** _Pending_  
**Date Completed:** _Pending_  
**Agent:** _Pending_  

---

## QA Results

**Status:** _Pending_
