# Story 1.3: OpenWeatherMap API Integration & Service Layer

## Status

Draft

## Story

**As a** developer,  
**I want** a complete API service layer for OpenWeatherMap integration,  
**so that** I can fetch current weather data reliably with proper error handling.

## Acceptance Criteria

1. OpenWeatherMap API key configured via environment variables
2. API service module created with TypeScript interfaces for weather data
3. Function created to fetch current weather by city name
4. Function created to fetch current weather by coordinates (lat/lon)
5. Proper error handling for API failures (network errors, invalid API key, city not found)
6. API responses parsed and typed with TypeScript interfaces
7. Unit tests written for API service functions using MSW for mocking
8. API call timeout and retry logic implemented
9. TanStack Query hooks created for weather data fetching with caching

## Tasks / Subtasks

### Task 1: Create TypeScript Interfaces for Weather Data (AC: 2, 6)
- [ ] Create `src/models/WeatherData.ts` with interface from architecture
- [ ] Create `src/models/Coordinates.ts` interface
- [ ] Define all nested interfaces (main, weather, wind, clouds, sys)
- [ ] Export interfaces for use in services and components

### Task 2: Create Zod Validation Schemas (AC: 6)
- [ ] Create `src/schemas/weatherSchema.ts`
- [ ] Define CoordinatesSchema for lat/lon validation
- [ ] Define WeatherDataSchema matching the interface
- [ ] Define nested schemas for all sub-objects
- [ ] Export schemas for runtime validation

### Task 3: Configure API Constants (AC: 1)
- [ ] Create `src/constants/api.ts`
- [ ] Define API_CONFIG object with key and baseUrl from env
- [ ] Add validation to check API key exists on app init
- [ ] Export API_CONFIG for use in services
- [ ] Document API key requirement in code comments

### Task 4: Create Axios Client with Interceptors (AC: 5, 8)
- [ ] Create `src/services/WeatherService.ts`
- [ ] Initialize Axios client with base configuration:
  - baseURL from constants
  - timeout: 10000ms
  - default params: appid, units=metric
- [ ] Add response interceptor for error handling
- [ ] Implement error transformation (404→NOT_FOUND, 429→RATE_LIMIT, etc.)
- [ ] Add request timeout logic
- [ ] Test interceptor catches errors correctly

### Task 5: Implement getCurrentWeatherByCity Function (AC: 3)
- [ ] Add async function: `getCurrentWeatherByCity(city: string)`
- [ ] Make GET request to `/weather?q={city}`
- [ ] Validate response with WeatherDataSchema
- [ ] Transform API response to WeatherData interface
- [ ] Handle errors and throw AppError with user-friendly messages
- [ ] Return typed WeatherData object

### Task 6: Implement getCurrentWeatherByCoords Function (AC: 4)
- [ ] Add async function: `getCurrentWeatherByCoords(lat: number, lon: number)`
- [ ] Validate coordinates are within valid ranges
- [ ] Make GET request to `/weather?lat={lat}&lon={lon}`
- [ ] Validate response with WeatherDataSchema
- [ ] Transform and return WeatherData
- [ ] Handle errors appropriately

### Task 7: Create TanStack Query Hooks (AC: 9)
- [ ] Create `src/hooks/useWeatherData.ts`
- [ ] Implement useWeatherData hook with useQuery
- [ ] Configure query key: ['weather', 'current', cityOrCoords]
- [ ] Set staleTime: 5 minutes, cacheTime: 10 minutes
- [ ] Implement retry logic (3 retries with exponential backoff)
- [ ] Add onError callback for error handling
- [ ] Return { data, isLoading, isError, error, refetch }

### Task 8: Implement Error Handling Strategy (AC: 5)
- [ ] Create `src/types/errors.ts` with AppError interface
- [ ] Define error types: NETWORK_ERROR, NOT_FOUND, RATE_LIMIT, etc.
- [ ] Implement handleApiError function in WeatherService
- [ ] Map HTTP status codes to error types:
  - 401 → UNAUTHORIZED
  - 404 → NOT_FOUND
  - 429 → RATE_LIMIT
  - 500-503 → SERVER_ERROR
  - No response → NETWORK_ERROR
- [ ] Include userMessage for each error type
- [ ] Add shouldRetry flag to errors

### Task 9: Write Unit Tests with MSW (AC: 7)
- [ ] Create `src/__tests__/services/WeatherService.test.ts`
- [ ] Set up MSW handlers for OpenWeatherMap endpoints
- [ ] Test getCurrentWeatherByCity success case
- [ ] Test getCurrentWeatherByCity with 404 error
- [ ] Test getCurrentWeatherByCoords success case
- [ ] Test network errors and retries
- [ ] Test API key validation
- [ ] Verify Zod validation catches malformed responses
- [ ] Aim for 90%+ test coverage for service layer

### Task 10: Create MSW Mock Handlers (AC: 7)
- [ ] Create `src/__tests__/mocks/handlers.ts`
- [ ] Add handler for `/weather?q={city}` endpoint
- [ ] Add handler for `/weather?lat={lat}&lon={lon}` endpoint
- [ ] Mock successful responses with valid data
- [ ] Mock error responses (404, 429, 500)
- [ ] Export handlers for use in tests

### Task 11: Integration Verification
- [ ] Test API calls work with real OpenWeatherMap API (manual)
- [ ] Verify error messages are user-friendly
- [ ] Check that retries work for transient failures
- [ ] Confirm caching prevents duplicate requests
- [ ] Verify TypeScript types are correct throughout
- [ ] Create git commit: `feat(api): complete OpenWeatherMap integration`

## Dev Notes

### OpenWeatherMap API Details
[Source: architecture.md#Section 6.1]

**Base URL:** `https://api.openweathermap.org/data/2.5`  
**API Version:** 2.5  
**Authentication:** API Key as query parameter  

**Current Weather Endpoints:**
1. By city name: `GET /weather?q={city}&appid={API_KEY}&units=metric`
2. By coordinates: `GET /weather?lat={lat}&lon={lon}&appid={API_KEY}&units=metric`

**Rate Limits:**
- Free tier: 60 calls/minute, 1,000,000 calls/month
- Caching strategy helps stay within limits

### Weather Data Model
[Source: architecture.md#Section 4.1]

```typescript
interface WeatherData {
  id: number;
  name: string;
  coord: { lat: number; lon: number };
  main: {
    temp: number;
    feels_like: number;
    humidity: number;
    pressure: number;
    temp_min: number;
    temp_max: number;
  };
  weather: Array<{
    id: number;
    main: string;
    description: string;
    icon: string;
  }>;
  wind: { speed: number; deg: number };
  clouds: { all: number };
  dt: number;
  sys: {
    country: string;
    sunrise: number;
    sunset: number;
  };
  timezone: number;
  visibility: number;
}
```

### Zod Schema Validation
[Source: architecture.md#Section 4.2]

All API responses MUST be validated with Zod before use. This provides runtime type safety and catches malformed API responses.

```typescript
import { z } from 'zod';

const CoordinatesSchema = z.object({
  lat: z.number().min(-90).max(90),
  lon: z.number().min(-180).max(180)
});

const WeatherDataSchema = z.object({
  id: z.number(),
  name: z.string(),
  coord: CoordinatesSchema,
  main: z.object({
    temp: z.number(),
    feels_like: z.number(),
    humidity: z.number().min(0).max(100),
    pressure: z.number()
  }),
  // ... full schema
});
```

### TanStack Query Configuration
[Source: architecture.md#Section 6.1]

```typescript
{
  staleTime: 5 * 60 * 1000,      // 5 minutes
  cacheTime: 10 * 60 * 1000,     // 10 minutes
  refetchOnWindowFocus: true,
  refetchOnMount: false,
  retry: 3,
  retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000)
}
```

**Cache Keys:**
- `['weather', 'current', cityName]`
- `['weather', 'current', { lat, lon }]`

### Error Handling Pattern
[Source: architecture.md#Section 12.3]

**HTTP Status Code Mapping:**
- `200` → Success
- `401` → Invalid API key (configuration error)
- `404` → City not found (user error)
- `429` → Rate limit exceeded (retry after 60s)
- `500-503` → Server errors (retry with backoff)
- No response → Network error (retry 3x)

**Error Object Structure:**
```typescript
interface AppError {
  type: string;
  message: string;
  userMessage: string;
  shouldRetry: boolean;
  retryAfter?: number;
}
```

### Axios Configuration
[Source: architecture.md#Section 3.1]

```typescript
import axios from 'axios';

const apiClient = axios.create({
  baseURL: import.meta.env.VITE_OPENWEATHER_BASE_URL,
  timeout: 10000,
  params: {
    appid: import.meta.env.VITE_OPENWEATHER_API_KEY,
    units: 'metric'
  }
});
```

### Service Layer Pattern
[Source: architecture.md#Section 2.3]

Use **Repository Pattern** - Services encapsulate all external API calls. Components never call APIs directly; they use hooks that call services.

### Testing with MSW
[Source: architecture.md#Section 14.4]

Mock Service Worker (MSW) provides network-level mocking:
- Intercepts HTTP requests during tests
- Returns mock responses without hitting real API
- Works in both tests and browser (dev mode)

**MSW Setup:**
```typescript
import { http, HttpResponse } from 'msw';

const handlers = [
  http.get('*/weather', ({ request }) => {
    const url = new URL(request.url);
    const city = url.searchParams.get('q');
    
    if (city === 'NotFound') {
      return HttpResponse.json(
        { message: 'city not found' },
        { status: 404 }
      );
    }
    
    return HttpResponse.json(mockWeatherData);
  })
];
```

### File Locations
[Source: architecture.md#Section 10.1]

- `src/services/WeatherService.ts` - API client
- `src/models/WeatherData.ts` - TypeScript interfaces
- `src/schemas/weatherSchema.ts` - Zod schemas
- `src/hooks/useWeatherData.ts` - TanStack Query hooks
- `src/constants/api.ts` - API configuration
- `src/types/errors.ts` - Error type definitions
- `src/__tests__/services/WeatherService.test.ts` - Unit tests
- `src/__tests__/mocks/handlers.ts` - MSW handlers

### Security Considerations
[Source: architecture.md#Section 15.2]

**API Key Exposure:**
- API keys are visible in client-side code (unavoidable for frontend-only apps)
- Mitigation: Restrict key by domain in OpenWeatherMap dashboard
- Free tier has low quota (1000 calls/day) limiting abuse
- Monitor usage daily in OpenWeatherMap dashboard

**Environment Variables:**
All must be prefixed with `VITE_` to be exposed to client.

### Success Criteria

This story is complete when:
1. WeatherService can fetch data by city name
2. WeatherService can fetch data by coordinates
3. All API responses are validated with Zod
4. Errors are handled gracefully with user-friendly messages
5. TanStack Query hooks provide caching and automatic refetch
6. Unit tests achieve 90%+ coverage
7. MSW mocks work in test environment
8. API calls work with real OpenWeatherMap API
9. TypeScript types prevent type errors
10. Retry logic works for transient failures

## Testing

### Unit Test Coverage Requirements
[Source: architecture.md#Section 14]

**Minimum Coverage:** 90% for services (higher than general 80% requirement)

**Test Cases Required:**

1. **getCurrentWeatherByCity:**
   - ✅ Success case with valid city
   - ✅ 404 error for invalid city
   - ✅ Network error handling
   - ✅ Rate limit error (429)
   - ✅ Zod validation catches malformed response

2. **getCurrentWeatherByCoords:**
   - ✅ Success case with valid coordinates
   - ✅ Invalid coordinate ranges rejected
   - ✅ Network error handling

3. **Error Handling:**
   - ✅ HTTP 401 → UNAUTHORIZED error
   - ✅ HTTP 404 → NOT_FOUND error
   - ✅ HTTP 429 → RATE_LIMIT error with retryAfter
   - ✅ HTTP 500 → SERVER_ERROR error
   - ✅ No response → NETWORK_ERROR

4. **TanStack Query Hook:**
   - ✅ Hook returns loading state initially
   - ✅ Hook returns data on success
   - ✅ Hook returns error on failure
   - ✅ Cache prevents duplicate requests
   - ✅ Stale data refetches after 5 minutes

### Manual Verification

1. **API Key Test:**
   - Verify app throws error if API key missing
   - Test with invalid API key → 401 error handled

2. **Network Test:**
   - Disconnect network → NETWORK_ERROR shown
   - Reconnect → Retry succeeds

3. **Rate Limit Test:**
   - Make 60+ requests in 1 minute
   - Verify 429 error handled gracefully

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-03 | 1.0 | Initial story draft created | Bob (SM) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_
