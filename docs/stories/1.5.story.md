# Story 1.5: Weather Animation Integration with Lottie

**Epic:** Epic 1 - Foundation & Core Weather Display  
**Story ID:** 1.5  
**Created:** 2025-12-03  
**Status:** Draft  

---

## Story

As a **user**,  
I want **to see beautiful animated weather icons that match current conditions**,  
so that **the app feels engaging and visually delightful**.

---

## Acceptance Criteria

1. Lottie React library integrated into project (version 2.4.0)
2. Weather animations sourced or created for key conditions (sunny, cloudy, rainy, snowy, etc.)
3. Lottie animations mapped to OpenWeatherMap condition codes
4. Animations play smoothly at 60fps without performance issues
5. Fallback to static icons if Lottie animation fails to load
6. Animations respect user's reduced motion preferences (prefers-reduced-motion)
7. Lottie files optimized for web (compressed JSON, minimal file size)
8. Animation component is reusable and accepts condition code as prop

---

## Tasks

### Task 1: Install and Configure Lottie React
**Acceptance Criteria:** AC1

**Subtasks:**
1. Install `lottie-react@2.4.0` via npm: `npm install lottie-react@2.4.0`
2. Verify installation in `package.json`
3. Import `Lottie` component in test file to confirm setup
4. Review Lottie React documentation for API usage
5. Test basic Lottie animation rendering with sample JSON
6. Configure TypeScript types for Lottie (included in package)

### Task 2: Source or Create Weather Lottie Animations
**Acceptance Criteria:** AC2, AC7

**Subtasks:**
1. Identify required weather conditions from OpenWeatherMap API (clear, clouds, rain, drizzle, snow, thunderstorm, mist, fog)
2. Source free Lottie animations from LottieFiles.com or similar
3. Download animations for: sunny/clear, partly cloudy, cloudy, light rain, heavy rain, snow, thunderstorm, fog/mist
4. Store animations in `public/animations/weather/` directory
5. Optimize Lottie JSON files with LottieFiles optimizer (reduce file size by 30-50%)
6. Ensure each animation is < 50KB for performance
7. Test animations in LottieFiles preview to verify quality
8. Document animation sources in README or attribution file

### Task 3: Create WeatherAnimation Component
**Acceptance Criteria:** AC3, AC4, AC5, AC6, AC8

**Subtasks:**
1. Create `src/components/weather/WeatherAnimation.tsx` component
2. Define props interface: `{ conditionCode: string, size?: 'sm' | 'md' | 'lg' }`
3. Map OpenWeatherMap condition codes to Lottie animation file paths
4. Create `animationMap` object mapping codes like '01d', '02d', '09d', etc. to animation URLs
5. Import `Lottie` component from `lottie-react`
6. Import animation JSON files dynamically or statically
7. Render `<Lottie animationData={animationData} loop autoplay />`
8. Add error handling: wrap in try-catch, fallback to static icon on error
9. Add size variants with Tailwind classes (w-24 h-24, w-32 h-32, w-48 h-48)
10. Implement reduced motion check: `const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches`
11. If reduced motion, render static first frame or fallback icon instead of animation
12. Add loading state while animation JSON loads (optional skeleton)

### Task 4: Implement Animation Mapping Logic
**Acceptance Criteria:** AC3

**Subtasks:**
1. Create `src/utils/weatherAnimations.ts` utility file
2. Define `getAnimationPath(conditionCode: string): string` function
3. Map OpenWeatherMap codes to animation files:
   - `01d`, `01n` → `sunny.json`
   - `02d`, `02n` → `partly-cloudy.json`
   - `03d`, `03n`, `04d`, `04n` → `cloudy.json`
   - `09d`, `09n`, `10d`, `10n` → `rain.json`
   - `11d`, `11n` → `thunderstorm.json`
   - `13d`, `13n` → `snow.json`
   - `50d`, `50n` → `mist.json`
4. Return full path: `/animations/weather/${filename}`
5. Handle unknown codes with default fallback: `cloudy.json`
6. Add TypeScript type for condition codes (union type)
7. Export function for use in `WeatherAnimation` component

### Task 5: Integrate WeatherAnimation into WeatherDisplay
**Acceptance Criteria:** AC8

**Subtasks:**
1. Import `WeatherAnimation` into `src/components/weather/WeatherDisplay.tsx`
2. Replace `<WeatherIcon>` component with `<WeatherAnimation>` (or use conditionally)
3. Pass `conditionCode={data?.weather[0]?.icon ?? '01d'}` as prop
4. Set size prop: `size="lg"` for main display
5. Test integration with real API data
6. Verify animations play correctly for different weather conditions
7. Ensure loading and error states still work
8. Test responsive behavior at all breakpoints

### Task 6: Optimize Performance
**Acceptance Criteria:** AC4, AC7

**Subtasks:**
1. Measure animation performance with Chrome DevTools Performance panel
2. Ensure animations run at 60fps on mid-range devices
3. Add `will-change: transform` CSS if animations are janky
4. Lazy load animation JSON files (dynamic imports)
5. Implement animation caching to avoid re-downloading
6. Compress Lottie JSON files (remove unnecessary metadata, optimize numbers)
7. Test file sizes: ensure each animation is < 50KB
8. Measure bundle size impact: run `npm run build` and check output
9. Consider using `lottie-web` lightweight mode if bundle size is excessive

### Task 7: Implement Accessibility & Reduced Motion
**Acceptance Criteria:** AC6

**Subtasks:**
1. Detect user's motion preference: `const reducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches`
2. Create React hook: `useReducedMotion()` returning boolean
3. In `WeatherAnimation`, conditionally render:
   - If `reducedMotion`, render static SVG or first frame of animation
   - Else, render full Lottie animation
4. Add ARIA label to animation: `aria-label={Weather animation for ${condition}}`
5. Ensure animation doesn't interfere with screen readers
6. Add `role="img"` to Lottie container
7. Test with VoiceOver/NVDA to verify accessibility

### Task 8: Add Fallback Handling
**Acceptance Criteria:** AC5

**Subtasks:**
1. Wrap Lottie rendering in error boundary or try-catch
2. Create fallback component: `<WeatherIconFallback conditionCode={code} />`
3. Fallback displays static SVG or OpenWeatherMap icon URL
4. Test fallback by intentionally breaking animation file path
5. Add console warning when fallback is used (dev mode only)
6. Ensure fallback has same sizing and styling as Lottie animation
7. Document fallback behavior in component comments

### Task 9: Create Tests for WeatherAnimation
**Acceptance Criteria:** AC1-AC8 (verification)

**Subtasks:**
1. Create `src/components/weather/WeatherAnimation.test.tsx`
2. Test: Renders Lottie component with correct animation data
3. Test: Maps condition codes correctly (sunny, rain, snow, etc.)
4. Test: Respects reduced motion preference (mock `matchMedia`)
5. Test: Falls back to static icon on animation load error
6. Test: Size prop applies correct classes (sm, md, lg)
7. Test: Handles unknown condition codes with default animation
8. Mock Lottie component to avoid animation execution in tests
9. Snapshot test for rendered output
10. Achieve 90%+ test coverage

---

## Dev Notes

### Architecture References

**Component Location:**  
`src/components/weather/WeatherAnimation.tsx` (as per Section 9: Source Tree Structure)

**Dependencies:**  
`lottie-react@2.4.0` (Section 3: Tech Stack - Animation Libraries)

**Animation Storage:**  
Store Lottie JSON files in `public/animations/weather/` directory for easy static serving.

**Performance:**  
Lottie animations are GPU-accelerated via SVG rendering. Ensure animations use transforms (not layout properties) for 60fps performance (Section 12.4: Performance Requirements).

**Accessibility:**  
Respect `prefers-reduced-motion` media query (Section 11.2: Accessibility Standards - WCAG AA compliance).

### Component Structure Example

```tsx
// src/components/weather/WeatherAnimation.tsx
import React from 'react';
import Lottie from 'lottie-react';
import { getAnimationPath } from '@/utils/weatherAnimations';
import { useReducedMotion } from '@/hooks/useReducedMotion';

interface WeatherAnimationProps {
  conditionCode: string;
  size?: 'sm' | 'md' | 'lg';
}

export const WeatherAnimation: React.FC<WeatherAnimationProps> = ({ 
  conditionCode, 
  size = 'md' 
}) => {
  const reducedMotion = useReducedMotion();
  const [animationData, setAnimationData] = React.useState(null);
  const [error, setError] = React.useState(false);

  React.useEffect(() => {
    const loadAnimation = async () => {
      try {
        const path = getAnimationPath(conditionCode);
        const response = await fetch(path);
        const data = await response.json();
        setAnimationData(data);
      } catch (err) {
        console.warn('Failed to load weather animation:', err);
        setError(true);
      }
    };
    loadAnimation();
  }, [conditionCode]);

  const sizeClasses = {
    sm: 'w-24 h-24',
    md: 'w-32 h-32',
    lg: 'w-48 h-48',
  };

  if (error || reducedMotion) {
    return <WeatherIconFallback conditionCode={conditionCode} size={size} />;
  }

  if (!animationData) {
    return <div className={`${sizeClasses[size]} animate-pulse bg-gray-200 rounded-full`} />;
  }

  return (
    <div className={sizeClasses[size]} role="img" aria-label={`Weather animation for ${conditionCode}`}>
      <Lottie animationData={animationData} loop autoplay />
    </div>
  );
};
```

### Animation Mapping Utility

```typescript
// src/utils/weatherAnimations.ts
export const getAnimationPath = (conditionCode: string): string => {
  const animationMap: Record<string, string> = {
    '01d': 'sunny.json',
    '01n': 'clear-night.json',
    '02d': 'partly-cloudy.json',
    '02n': 'partly-cloudy-night.json',
    '03d': 'cloudy.json',
    '03n': 'cloudy.json',
    '04d': 'cloudy.json',
    '04n': 'cloudy.json',
    '09d': 'rain.json',
    '09n': 'rain.json',
    '10d': 'rain.json',
    '10n': 'rain.json',
    '11d': 'thunderstorm.json',
    '11n': 'thunderstorm.json',
    '13d': 'snow.json',
    '13n': 'snow.json',
    '50d': 'mist.json',
    '50n': 'mist.json',
  };

  const filename = animationMap[conditionCode] ?? 'cloudy.json';
  return `/animations/weather/${filename}`;
};
```

### Reduced Motion Hook

```typescript
// src/hooks/useReducedMotion.ts
import { useState, useEffect } from 'react';

export const useReducedMotion = (): boolean => {
  const [reducedMotion, setReducedMotion] = useState(false);

  useEffect(() => {
    const mediaQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
    setReducedMotion(mediaQuery.matches);

    const handleChange = (e: MediaQueryListEvent) => setReducedMotion(e.matches);
    mediaQuery.addEventListener('change', handleChange);
    return () => mediaQuery.removeEventListener('change', handleChange);
  }, []);

  return reducedMotion;
};
```

### Testing Strategy

**Unit Tests:**
- Test animation mapping logic (`getAnimationPath`)
- Test reduced motion detection (`useReducedMotion`)
- Test component rendering with different condition codes
- Test fallback behavior on animation load error
- Mock `Lottie` component to avoid animation execution

**Visual Testing:**
- Manual testing with different weather conditions
- Test on real devices (iOS, Android) to verify performance
- Verify animations at 60fps with Chrome DevTools

**Accessibility Testing:**
- Enable reduced motion in OS settings, verify static fallback
- Test with screen reader to ensure animations don't interfere

### Performance Optimization

**File Size Targets:**
- Each Lottie JSON: < 50KB
- Total animations bundle: < 300KB (6-8 animations)

**Optimization Techniques:**
1. Use LottieFiles optimizer to compress JSON
2. Remove unnecessary layers and metadata
3. Reduce animation complexity (fewer keyframes)
4. Lazy load animation files (don't bundle with main JS)
5. Cache animation JSON in browser (serve with cache headers)

### Animation Sources

**Recommended Sources:**
- LottieFiles.com (free weather animations)
- IconScout (premium Lottie animations)
- Create custom with After Effects + Bodymovin plugin

**Attribution:**
If using free animations, add attribution in `public/ATTRIBUTIONS.md`.

---

## Testing

### Test Scenarios

1. **Animation Rendering:** Verify Lottie animations render for all condition codes
2. **Mapping Logic:** Test `getAnimationPath` returns correct files for each code
3. **Reduced Motion:** Verify static fallback when `prefers-reduced-motion` is enabled
4. **Error Handling:** Test fallback when animation file is missing or corrupted
5. **Performance:** Verify 60fps animation on mid-range device (Chrome DevTools)
6. **File Size:** Confirm each animation is < 50KB
7. **Accessibility:** Screen reader announces animation context correctly
8. **Integration:** WeatherAnimation works in WeatherDisplay component

### Coverage Requirement
- **Target:** 90%+ line coverage
- **Tools:** Vitest + React Testing Library
- **Mocking:** Mock Lottie component and fetch API

---

## Change Log

| Date | Author | Change |
|------|--------|--------|
| 2025-12-03 | SM (Bob) | Story created from PRD Epic 1, Story 1.5 |

---

## Dev Agent Record

### Implementation Session

**Date Started:** _Pending_  
**Date Completed:** _Pending_  
**Agent:** _Pending_  
**Time Spent:** _Pending_  

**Notes:**  
_Implementation notes will be added by Dev Agent during execution._

---

## QA Results

**Tested By:** _Pending_  
**Test Date:** _Pending_  
**Status:** _Pending_  

**Test Results:**  
_QA validation results will be added after implementation._
