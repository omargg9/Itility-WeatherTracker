# Story 1.4: Current Weather Display Component

**Epic:** Epic 1 - Foundation & Core Weather Display  
**Story ID:** 1.4  
**Created:** 2025-12-03  
**Status:** Draft  

---

## Story

As a **user**,  
I want **to see current weather clearly displayed with temperature, conditions, and icon**,  
so that **I get immediate, at-a-glance weather information**.

---

## Acceptance Criteria

1. Current weather component created displaying temperature prominently
2. Weather condition text clearly shown (e.g., "Partly Cloudy", "Rainy")
3. Weather icon displayed using OpenWeatherMap icon codes or custom icons
4. "Feels like" temperature included with subtle distinction from actual temp
5. Component receives data from TanStack Query hook (Story 1.3)
6. Loading state displayed with skeleton or spinner while fetching weather
7. Error state displayed with helpful message if weather fetch fails
8. Component is fully responsive across mobile, tablet, and desktop
9. Tailwind CSS used for all styling with consistent design tokens

---

## Tasks

### Task 1: Create WeatherDisplay Component Structure
**Acceptance Criteria:** AC1, AC2, AC3, AC4, AC8, AC9

**Subtasks:**
1. Create `src/components/weather/WeatherDisplay.tsx` component file
2. Define component props interface: `WeatherDisplayProps` with optional `locationName?: string`
3. Create responsive layout with CSS Grid or Flexbox for weather information
4. Add container with Tailwind glassmorphism styles (backdrop-blur, bg-opacity)
5. Implement temperature display with large, prominent typography (text-6xl or text-7xl)
6. Add weather condition text below temperature (text-xl, font-medium)
7. Position weather icon prominently (left or right of temperature)
8. Add "Feels like" temperature in smaller text (text-lg, text-gray-600)
9. Ensure all elements scale properly at breakpoints (sm, md, lg, xl)
10. Add proper spacing and padding for mobile touch targets (min 44x44px)

### Task 2: Integrate TanStack Query for Weather Data
**Acceptance Criteria:** AC5

**Subtasks:**
1. Import `useWeatherQuery` hook from `src/services/weather/hooks.ts` (created in Story 1.3)
2. Call `useWeatherQuery` with location coordinates (lat, lon)
3. Destructure `{ data, isLoading, isError, error }` from query result
4. Pass `data?.main.temp`, `data?.weather[0].description`, `data?.main.feels_like` to display elements
5. Extract weather icon code from `data?.weather[0].icon`
6. Handle case when data is undefined (initial load)
7. Add type guards to ensure safe property access
8. Configure query with proper staleTime (5 minutes as per architecture)

### Task 3: Implement Loading State
**Acceptance Criteria:** AC6

**Subtasks:**
1. Create conditional rendering: `if (isLoading) return <LoadingSkeleton />`
2. Build `LoadingSkeleton` component with animated placeholder elements
3. Use Tailwind `animate-pulse` for skeleton animation
4. Match skeleton layout to actual weather display (same dimensions)
5. Add skeleton elements for temperature, condition text, and icon
6. Use `bg-gray-200/50` or similar for skeleton backgrounds
7. Ensure skeleton is accessible (aria-label="Loading weather data")
8. Test loading state by throttling network in DevTools

### Task 4: Implement Error State
**Acceptance Criteria:** AC7

**Subtasks:**
1. Create conditional rendering: `if (isError) return <ErrorDisplay error={error} />`
2. Build `ErrorDisplay` component accepting `error` prop
3. Display user-friendly error messages (not technical details)
4. Map API error codes to helpful messages:
   - 404: "Location not found. Please try another city."
   - 401: "Unable to fetch weather. Please try again later."
   - 429: "Too many requests. Please wait a moment."
   - 500: "Weather service unavailable. Please try again."
5. Add retry button that refetches query (`queryClient.invalidateQueries`)
6. Style error state with red accent (text-red-600, border-red-300)
7. Include icon or illustration for error state
8. Ensure error message is accessible (role="alert")

### Task 5: Add Weather Icon Display
**Acceptance Criteria:** AC3

**Subtasks:**
1. Create `WeatherIcon` component in `src/components/weather/WeatherIcon.tsx`
2. Accept props: `iconCode: string, size?: 'sm' | 'md' | 'lg'`
3. Map OpenWeatherMap icon codes to icon URLs: `https://openweathermap.org/img/wn/${iconCode}@2x.png`
4. Render `<img>` with proper alt text (weather description)
5. Add size variants with Tailwind classes (w-16 h-16, w-24 h-24, w-32 h-32)
6. Handle missing or invalid icon codes with fallback icon
7. Add loading="lazy" for performance
8. Ensure icon scales properly on all screen sizes
9. Optional: Add subtle animation on icon load (fade-in with Framer Motion)

### Task 6: Apply Responsive Design & Tailwind Styling
**Acceptance Criteria:** AC8, AC9

**Subtasks:**
1. Define mobile layout (320px-767px): stacked vertical layout
2. Define tablet layout (768px-1023px): horizontal layout with icon on left
3. Define desktop layout (1024px+): expanded horizontal with more spacing
4. Use Tailwind responsive prefixes: `flex-col md:flex-row lg:gap-8`
5. Test layout at all breakpoints: 320px, 375px, 768px, 1024px, 1440px
6. Ensure text doesn't overflow at small widths (truncate, wrap)
7. Add consistent padding/margin: `p-4 md:p-6 lg:p-8`
8. Use design tokens from Tailwind config (colors, spacing, typography)
9. Apply glassmorphism styles: `backdrop-blur-md bg-white/30 border border-white/20`

### Task 7: Add Accessibility Features
**Acceptance Criteria:** AC1, AC2, AC4, AC7

**Subtasks:**
1. Add semantic HTML: use `<article>` or `<section>` for weather display
2. Include proper heading hierarchy (`<h2>` for temperature, `<h3>` for condition)
3. Add ARIA labels for icon (`aria-label="Weather icon"`)
4. Ensure sufficient color contrast for text (WCAG AA compliant)
5. Add focus styles for interactive elements (retry button)
6. Test with screen reader (VoiceOver or NVDA)
7. Add `aria-live="polite"` to weather display for dynamic updates
8. Ensure loading/error states are announced to screen readers

### Task 8: Create Component Tests
**Acceptance Criteria:** AC1-AC9 (verification)

**Subtasks:**
1. Create `src/components/weather/WeatherDisplay.test.tsx`
2. Test: Renders loading state when `isLoading` is true
3. Test: Renders error state when `isError` is true with error message
4. Test: Renders weather data when query succeeds
5. Test: Displays temperature in correct format (rounded to whole number)
6. Test: Displays "Feels like" temperature
7. Test: Renders weather icon with correct src URL
8. Test: Renders weather condition description
9. Test: Responsive classes applied correctly (snapshot test)
10. Mock `useWeatherQuery` hook with MSW or Jest mocks
11. Test error message mapping for different error codes
12. Achieve 90%+ test coverage for component

### Task 9: Integrate Component into HomePage
**Acceptance Criteria:** AC1-AC9 (integration)

**Subtasks:**
1. Import `WeatherDisplay` into `src/pages/HomePage.tsx`
2. Pass default location coordinates (e.g., user's location or default city)
3. Wrap in container div with proper layout
4. Add location name display above weather component
5. Test full integration with actual API calls (use `.env` API key)
6. Verify loading → success flow works
7. Verify error handling works (test with invalid coordinates)
8. Ensure no layout shift when data loads (reserve space)
9. Add proper spacing between header and weather display

---

## Dev Notes

### Architecture References

**Component Location:**  
`src/components/weather/WeatherDisplay.tsx` (as per Section 9: Source Tree Structure)

**Data Models:**  
Use `WeatherResponse` and `WeatherData` types from `src/services/weather/types.ts` (Section 4: Data Models, Weather Data Model).

**TanStack Query Integration:**  
Import `useWeatherQuery` from `src/services/weather/hooks.ts` (Story 1.3). Query configuration per Section 6.1: External APIs Integration - cacheTime 10min, staleTime 5min.

**Styling Approach:**  
Tailwind CSS utility classes (Section 11: Coding Standards & Conventions). Use design tokens from `tailwind.config.js`. Glassmorphism effects: `backdrop-blur-md bg-white/30 border border-white/20 rounded-xl shadow-lg`.

**Responsive Breakpoints:**  
- Mobile: `< 768px` (default, no prefix)
- Tablet: `768px - 1023px` (md: prefix)
- Desktop: `>= 1024px` (lg: prefix)

### Component Structure Example

```tsx
// src/components/weather/WeatherDisplay.tsx
import React from 'react';
import { useWeatherQuery } from '@/services/weather/hooks';
import { WeatherIcon } from './WeatherIcon';

interface WeatherDisplayProps {
  lat: number;
  lon: number;
  locationName?: string;
}

export const WeatherDisplay: React.FC<WeatherDisplayProps> = ({ lat, lon, locationName }) => {
  const { data, isLoading, isError, error } = useWeatherQuery({ lat, lon });

  if (isLoading) {
    return <LoadingSkeleton />;
  }

  if (isError) {
    return <ErrorDisplay error={error} />;
  }

  const temp = Math.round(data?.main.temp ?? 0);
  const feelsLike = Math.round(data?.main.feels_like ?? 0);
  const condition = data?.weather[0]?.description ?? 'Unknown';
  const iconCode = data?.weather[0]?.icon ?? '01d';

  return (
    <article className="backdrop-blur-md bg-white/30 border border-white/20 rounded-xl shadow-lg p-6 md:p-8">
      {locationName && <h2 className="text-xl font-semibold mb-4">{locationName}</h2>}
      <div className="flex flex-col md:flex-row items-center gap-4 md:gap-8">
        <WeatherIcon iconCode={iconCode} size="lg" />
        <div className="text-center md:text-left">
          <p className="text-7xl font-bold">{temp}°</p>
          <p className="text-xl font-medium capitalize mt-2">{condition}</p>
          <p className="text-lg text-gray-600 mt-1">Feels like {feelsLike}°</p>
        </div>
      </div>
    </article>
  );
};
```

### Error Handling Pattern

Map API error codes to user-friendly messages (Section 10.1: Error Handling Strategy):

```typescript
const getErrorMessage = (error: unknown): string => {
  if (error instanceof AxiosError) {
    switch (error.response?.status) {
      case 404: return "Location not found. Please try another city.";
      case 401: return "Unable to fetch weather. Please try again later.";
      case 429: return "Too many requests. Please wait a moment.";
      case 500: return "Weather service unavailable. Please try again.";
      default: return "An unexpected error occurred.";
    }
  }
  return "Unable to load weather data.";
};
```

### Testing Strategy

**Unit Tests (React Testing Library + Vitest):**
- Test loading state rendering
- Test error state with different error codes
- Test successful data display
- Test responsive class application
- Mock `useWeatherQuery` hook to control state

**Example Test:**
```typescript
// src/components/weather/WeatherDisplay.test.tsx
import { render, screen } from '@testing-library/react';
import { WeatherDisplay } from './WeatherDisplay';
import { useWeatherQuery } from '@/services/weather/hooks';

vi.mock('@/services/weather/hooks');

describe('WeatherDisplay', () => {
  it('displays loading state', () => {
    (useWeatherQuery as vi.Mock).mockReturnValue({ isLoading: true, isError: false, data: null });
    render(<WeatherDisplay lat={40.7128} lon={-74.0060} />);
    expect(screen.getByLabelText(/loading/i)).toBeInTheDocument();
  });

  it('displays weather data when loaded', () => {
    const mockData = {
      main: { temp: 72, feels_like: 70 },
      weather: [{ description: 'clear sky', icon: '01d' }],
    };
    (useWeatherQuery as vi.Mock).mockReturnValue({ isLoading: false, isError: false, data: mockData });
    render(<WeatherDisplay lat={40.7128} lon={-74.0060} />);
    expect(screen.getByText('72°')).toBeInTheDocument();
    expect(screen.getByText(/clear sky/i)).toBeInTheDocument();
  });
});
```

**Coverage Target:** 90%+ (Section 12.3: Test Coverage Goals)

### Performance Considerations

- Use `loading="lazy"` for weather icon images
- Reserve space for weather display to prevent layout shift (CLS)
- Optimize glassmorphism effects with `will-change: backdrop-filter` if needed
- Ensure TanStack Query caching reduces API calls (5min staleTime)

### Design Tokens (Tailwind)

**Typography:**
- Temperature: `text-6xl md:text-7xl font-bold`
- Condition: `text-xl font-medium`
- Feels like: `text-lg text-gray-600`

**Spacing:**
- Mobile padding: `p-4`
- Tablet/Desktop padding: `md:p-6 lg:p-8`
- Gap between elements: `gap-4 md:gap-8`

**Glassmorphism:**
- Background: `bg-white/30`
- Backdrop blur: `backdrop-blur-md`
- Border: `border border-white/20`
- Shadow: `shadow-lg`

---

## Testing

### Test Scenarios

1. **Loading State:** Verify skeleton displays when `isLoading` is true
2. **Error State:** Verify error message and retry button when `isError` is true
3. **Success State:** Verify temperature, condition, icon, and "feels like" display
4. **Responsive Layout:** Test at 320px, 768px, 1024px breakpoints
5. **Accessibility:** Screen reader announces weather updates, sufficient contrast
6. **Error Message Mapping:** Test 404, 401, 429, 500 error codes
7. **Icon Rendering:** Verify correct icon URL generated from icon code
8. **Integration:** Verify component works in HomePage with actual API

### Coverage Requirement
- **Target:** 90%+ line coverage
- **Tools:** Vitest + React Testing Library
- **Mocking:** Mock `useWeatherQuery` hook for controlled testing

---

## Change Log

| Date | Author | Change |
|------|--------|--------|
| 2025-12-03 | SM (Bob) | Story created from PRD Epic 1, Story 1.4 |

---

## Dev Agent Record

### Implementation Session

**Date Started:** _Pending_  
**Date Completed:** _Pending_  
**Agent:** _Pending_  
**Time Spent:** _Pending_  

**Notes:**  
_Implementation notes will be added by Dev Agent during execution._

---

## QA Results

**Tested By:** _Pending_  
**Test Date:** _Pending_  
**Status:** _Pending_  

**Test Results:**  
_QA validation results will be added after implementation._
