# Story 2.5: Geolocation Auto-Detection

**Epic:** Epic 2 - Enhanced Forecast & Location Features  
**Story ID:** 2.5  
**Created:** 2025-12-03  
**Status:** Draft  

---

## Story

As a **user**,  
I want **the app to detect my current location automatically**,  
so that **I see weather for where I am without manual searching**.

---

## Acceptance Criteria

1. App requests geolocation permission on first visit
2. Browser Geolocation API integrated and working
3. If permission granted, weather automatically loads for current location
4. Geolocation result cached to avoid repeated permission prompts
5. Manual "Use My Location" button provided in search/location interface
6. Loading state displayed while detecting location
7. Error handling for permission denied with fallback to search
8. Error handling for geolocation failure (show default city or prompt)
9. Geolocation preference saved in localStorage
10. "Detecting location..." message with animated feedback
11. Works seamlessly on both mobile and desktop browsers

---

## Tasks

### Task 1: Implement Geolocation Service
- Create `useGeolocation` custom hook
- Use `navigator.geolocation.getCurrentPosition()`
- Handle success: extract lat/lon coordinates
- Handle errors: permission denied, timeout, unavailable
- Add timeout configuration (10 seconds)

### Task 2: Create Location Permission Flow
- On app first load, check localStorage for saved location
- If no saved location, request geolocation permission
- Display permission request dialog/prompt
- Handle user acceptance → fetch location
- Handle user denial → show search interface
- Save permission status to localStorage

### Task 3: Add "Use My Location" Button
- Create button component with location icon
- Position in header or search area
- On click, request geolocation permission
- Show loading state while getting location
- Update weather display with detected location

### Task 4: Implement Loading State
- Display "Detecting your location..." message
- Show animated spinner or pulse effect
- Use Framer Motion for smooth animation
- Ensure accessible with screen reader announcement

### Task 5: Handle Geolocation Errors
- Permission denied: Show message, default to search
- Timeout: Show error, retry option
- Position unavailable: Fall back to default city or IP-based location
- Display user-friendly error messages
- Add retry button for recoverable errors

### Task 6: Cache Location Data
- Save detected coordinates to localStorage
- Include timestamp to determine freshness
- Auto-use cached location on subsequent visits
- Clear cache after 24 hours or on manual location change

### Task 7: Create Tests
- Test geolocation success flow
- Test permission denied handling
- Test timeout and error scenarios
- Test localStorage caching
- Mock `navigator.geolocation` API
- Achieve 90%+ coverage

---

## Dev Notes

**Geolocation API:** `navigator.geolocation.getCurrentPosition(success, error, options)`

**Options:** `{ enableHighAccuracy: false, timeout: 10000, maximumAge: 600000 }` (10min cache)

**LocalStorage Key:** `weather-app-location` with structure `{ lat, lon, timestamp }`

**Error Codes:**
- `PERMISSION_DENIED` (1): User denied permission
- `POSITION_UNAVAILABLE` (2): Location unavailable
- `TIMEOUT` (3): Request timed out

---

## Testing

Test geolocation API integration, permission handling, caching, error states, and retry logic.

**Coverage:** 90%+

---

## Change Log

| Date | Author | Change |
|------|--------|--------|
| 2025-12-03 | SM (Bob) | Story created from PRD Epic 2, Story 2.5 |

---

## Dev Agent Record

**Date Started:** _Pending_  
**Date Completed:** _Pending_  
**Agent:** _Pending_  

---

## QA Results

**Status:** _Pending_
