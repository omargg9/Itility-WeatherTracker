# Story 2.1: 5-Day Forecast API Integration

**Epic:** Epic 2 - Enhanced Forecast & Location Features  
**Story ID:** 2.1  
**Created:** 2025-12-03  
**Status:** Draft  

---

## Story

As a **developer**,  
I want **to integrate the 5-day forecast API endpoint from OpenWeatherMap**,  
so that **the app can display extended weather forecasts to users**.

---

## Acceptance Criteria

1. 5-day forecast API service function created using existing weather service patterns
2. Forecast API endpoint correctly calls `https://api.openweathermap.org/data/2.5/forecast`
3. Request includes required parameters: lat, lon, appid, units=imperial
4. Response validated with Zod schema matching forecast data structure
5. TanStack Query hook created: `useForecastQuery` with proper caching (staleTime: 10 min)
6. Error handling implemented for all API failure scenarios (401, 404, 429, 500)
7. TypeScript interfaces defined for forecast data (list of 3-hour intervals, 40 entries)
8. MSW mock handlers created for testing forecast API calls

---

## Tasks

### Task 1: Define Forecast Data Types
**Acceptance Criteria:** AC7

**Subtasks:**
1. Create `ForecastResponse` interface in `src/services/weather/types.ts`
2. Define `ForecastEntry` interface matching 3-hour forecast data structure
3. Add `list` array property containing 40 forecast entries (5 days × 8 entries/day)
4. Include properties: `dt` (timestamp), `main` (temp, feels_like, humidity), `weather` (description, icon), `wind`, `clouds`, `pop` (probability of precipitation)
5. Add `city` property with location info (name, country, timezone)
6. Extend existing weather types or reuse where applicable
7. Export all new types from `types.ts`

### Task 2: Create Zod Validation Schema
**Acceptance Criteria:** AC4

**Subtasks:**
1. Create `ForecastEntrySchema` in `src/services/weather/schemas.ts`
2. Define schema matching `ForecastEntry` interface
3. Validate `dt` as number, `main.temp` as number, `weather` as array
4. Add validation for `pop` (probability of precipitation) as number 0-1
5. Create `ForecastResponseSchema` wrapping list of entries
6. Use existing `WeatherDataSchema` components where possible (DRY principle)
7. Add `.strict()` to catch unexpected fields
8. Export schemas for use in service functions

### Task 3: Implement Forecast API Service Function
**Acceptance Criteria:** AC1, AC2, AC3

**Subtasks:**
1. Create `getForecast` function in `src/services/weather/weatherService.ts`
2. Accept parameters: `{ lat: number, lon: number }`
3. Build URL: `https://api.openweathermap.org/data/2.5/forecast`
4. Add query params: `lat`, `lon`, `appid=${API_KEY}`, `units=imperial`
5. Use existing Axios client from Story 1.3 with interceptors
6. Set timeout: 10 seconds (consistent with current weather)
7. Validate response with `ForecastResponseSchema.parse(response.data)`
8. Return typed `ForecastResponse` data
9. Add JSDoc comment documenting function purpose and params

### Task 4: Implement Error Handling
**Acceptance Criteria:** AC6

**Subtasks:**
1. Wrap API call in try-catch block
2. Handle Axios errors with existing error mapping pattern
3. Map error codes to user-friendly messages:
   - 401: "API key invalid. Please check configuration."
   - 404: "Forecast not available for this location."
   - 429: "Too many requests. Please wait a moment."
   - 500: "Forecast service unavailable. Please try again."
   - Network errors: "Unable to connect. Check your internet connection."
4. Throw custom error with mapped message
5. Log errors to console in development mode
6. Ensure errors propagate to TanStack Query for UI handling

### Task 5: Create TanStack Query Hook
**Acceptance Criteria:** AC5

**Subtasks:**
1. Create `useForecastQuery` hook in `src/services/weather/hooks.ts`
2. Accept params: `{ lat: number, lon: number }`
3. Use TanStack Query `useQuery` with key: `['forecast', lat, lon]`
4. Set `queryFn` to call `getForecast({ lat, lon })`
5. Configure `staleTime: 10 * 60 * 1000` (10 minutes)
6. Configure `cacheTime: 15 * 60 * 1000` (15 minutes)
7. Set `refetchOnWindowFocus: false` to prevent excessive API calls
8. Return `{ data, isLoading, isError, error, refetch }` from useQuery
9. Add TypeScript return type for hook

### Task 6: Create MSW Mock Handlers
**Acceptance Criteria:** AC8

**Subtasks:**
1. Create mock forecast data in `src/mocks/forecastData.ts`
2. Generate 40 forecast entries with realistic 3-hour intervals
3. Vary temperature, conditions, and precipitation probability across entries
4. Add MSW handler in `src/mocks/handlers.ts` for `/data/2.5/forecast` endpoint
5. Return mock forecast data with 200 status
6. Add handler for 404 error (invalid coordinates)
7. Add handler for 401 error (invalid API key)
8. Add handler for 429 error (rate limit)
9. Test handlers with MSW server in dev mode

### Task 7: Add Utility Functions for Forecast Processing
**Acceptance Criteria:** AC7

**Subtasks:**
1. Create `src/utils/forecastUtils.ts` file
2. Add `groupForecastByDay` function to group 40 entries into 5 days
3. Add `getHighLowTemps` function to extract daily high/low from 3-hour entries
4. Add `getDailyCondition` function to determine primary condition for each day (most frequent or worst)
5. Add `getDailyPrecipitation` function to calculate max precipitation probability per day
6. Export all utilities for use in components
7. Add unit tests for utility functions

### Task 8: Create Integration Tests
**Acceptance Criteria:** AC1-AC8 (verification)

**Subtasks:**
1. Create `src/services/weather/weatherService.forecast.test.ts`
2. Test: `getForecast` returns valid forecast data
3. Test: Request includes correct URL and query parameters
4. Test: Response validated with Zod schema (invalid data throws)
5. Test: Error handling maps 401, 404, 429, 500 correctly
6. Test: Network errors handled gracefully
7. Mock Axios responses with MSW or Jest mocks
8. Achieve 90%+ coverage for forecast service functions

### Task 9: Create Hook Tests
**Acceptance Criteria:** AC5 (verification)

**Subtasks:**
1. Create `src/services/weather/hooks.forecast.test.tsx`
2. Test: `useForecastQuery` fetches forecast data successfully
3. Test: Hook uses correct query key `['forecast', lat, lon]`
4. Test: `staleTime` and `cacheTime` configured correctly
5. Test: Hook returns loading state while fetching
6. Test: Hook returns error state on API failure
7. Test: Hook refetches when coordinates change
8. Use React Testing Library + Vitest to test hook behavior
9. Mock `getForecast` service function

---

## Dev Notes

### Architecture References

**API Endpoint:**  
`https://api.openweathermap.org/data/2.5/forecast` (Section 6.1: External APIs Integration - OpenWeatherMap 5-day forecast)

**Service Layer Pattern:**  
Follow existing patterns from Story 1.3 (`getCurrentWeather`, Axios client, error handling)

**TanStack Query Configuration:**  
- staleTime: 10 minutes (Section 6.1: External APIs Integration)
- cacheTime: 15 minutes
- Avoid refetching on window focus (conserve API quota)

**Data Structure:**  
Forecast API returns 40 entries (5 days × 8 three-hour intervals). Each entry has same structure as current weather but includes `dt_txt` (timestamp) and `pop` (precipitation probability).

### Type Definitions Example

```typescript
// src/services/weather/types.ts
export interface ForecastEntry {
  dt: number; // Unix timestamp
  dt_txt: string; // "2024-01-15 12:00:00"
  main: {
    temp: number;
    feels_like: number;
    temp_min: number;
    temp_max: number;
    humidity: number;
    pressure: number;
  };
  weather: Array<{
    id: number;
    main: string;
    description: string;
    icon: string;
  }>;
  clouds: { all: number };
  wind: { speed: number; deg: number };
  pop: number; // Probability of precipitation (0-1)
  visibility: number;
}

export interface ForecastResponse {
  list: ForecastEntry[];
  city: {
    id: number;
    name: string;
    country: string;
    timezone: number;
    sunrise: number;
    sunset: number;
  };
}
```

### Zod Schema Example

```typescript
// src/services/weather/schemas.ts
import { z } from 'zod';

export const ForecastEntrySchema = z.object({
  dt: z.number(),
  dt_txt: z.string(),
  main: z.object({
    temp: z.number(),
    feels_like: z.number(),
    temp_min: z.number(),
    temp_max: z.number(),
    humidity: z.number(),
    pressure: z.number(),
  }),
  weather: z.array(
    z.object({
      id: z.number(),
      main: z.string(),
      description: z.string(),
      icon: z.string(),
    })
  ),
  clouds: z.object({ all: z.number() }),
  wind: z.object({ speed: z.number(), deg: z.number() }),
  pop: z.number().min(0).max(1),
  visibility: z.number(),
});

export const ForecastResponseSchema = z.object({
  list: z.array(ForecastEntrySchema),
  city: z.object({
    id: z.number(),
    name: z.string(),
    country: z.string(),
    timezone: z.number(),
    sunrise: z.number(),
    sunset: z.number(),
  }),
});
```

### Service Function Example

```typescript
// src/services/weather/weatherService.ts
import { axiosClient } from './axiosClient';
import { ForecastResponse, ForecastResponseSchema } from './schemas';

export const getForecast = async ({ lat, lon }: { lat: number; lon: number }): Promise<ForecastResponse> => {
  try {
    const response = await axiosClient.get('/data/2.5/forecast', {
      params: {
        lat,
        lon,
        appid: import.meta.env.VITE_OPENWEATHER_API_KEY,
        units: 'imperial',
      },
    });

    const validatedData = ForecastResponseSchema.parse(response.data);
    return validatedData;
  } catch (error) {
    if (axios.isAxiosError(error)) {
      const message = mapErrorToMessage(error.response?.status);
      throw new Error(message);
    }
    throw error;
  }
};
```

### TanStack Query Hook Example

```typescript
// src/services/weather/hooks.ts
import { useQuery } from '@tanstack/react-query';
import { getForecast } from './weatherService';

export const useForecastQuery = ({ lat, lon }: { lat: number; lon: number }) => {
  return useQuery({
    queryKey: ['forecast', lat, lon],
    queryFn: () => getForecast({ lat, lon }),
    staleTime: 10 * 60 * 1000, // 10 minutes
    cacheTime: 15 * 60 * 1000, // 15 minutes
    refetchOnWindowFocus: false,
  });
};
```

### Forecast Utility Example

```typescript
// src/utils/forecastUtils.ts
import { ForecastEntry } from '@/services/weather/types';

export const groupForecastByDay = (entries: ForecastEntry[]): Record<string, ForecastEntry[]> => {
  return entries.reduce((acc, entry) => {
    const date = new Date(entry.dt * 1000).toLocaleDateString();
    if (!acc[date]) acc[date] = [];
    acc[date].push(entry);
    return acc;
  }, {} as Record<string, ForecastEntry[]>);
};

export const getHighLowTemps = (entries: ForecastEntry[]): { high: number; low: number } => {
  const temps = entries.map(e => e.main.temp);
  return { high: Math.max(...temps), low: Math.min(...temps) };
};
```

### Testing Strategy

**Unit Tests:**
- Test `getForecast` service function with mocked Axios
- Test Zod schema validation (valid and invalid data)
- Test error handling for all error codes
- Test `useForecastQuery` hook with React Testing Library
- Test forecast utility functions

**Integration Tests:**
- Test full flow: hook → service → API → validation
- Test MSW mock handlers return correct data
- Test caching behavior (staleTime, cacheTime)

**Coverage Target:** 90%+ for service layer and hooks

### API Quota Considerations

Free tier: 1000 calls/day. With staleTime of 10 minutes, caching reduces API calls significantly. Monitor usage in development.

---

## Testing

### Test Scenarios

1. **Successful Forecast Fetch:** Verify `getForecast` returns valid 40-entry forecast
2. **Query Parameters:** Confirm lat, lon, appid, units=imperial sent correctly
3. **Zod Validation:** Test schema rejects invalid data (missing fields, wrong types)
4. **Error Handling:** Test 401, 404, 429, 500 error responses
5. **TanStack Query Hook:** Verify `useForecastQuery` caches and refetches correctly
6. **Utility Functions:** Test `groupForecastByDay`, `getHighLowTemps` with sample data
7. **MSW Mocking:** Verify mock handlers work in dev mode
8. **Coordinate Changes:** Test query refetches when lat/lon changes

### Coverage Requirement
- **Target:** 90%+ line coverage
- **Tools:** Vitest + React Testing Library + MSW
- **Focus:** Service functions, hooks, schemas, utilities

---

## Change Log

| Date | Author | Change |
|------|--------|--------|
| 2025-12-03 | SM (Bob) | Story created from PRD Epic 2, Story 2.1 |

---

## Dev Agent Record

### Implementation Session

**Date Started:** _Pending_  
**Date Completed:** _Pending_  
**Agent:** _Pending_  
**Time Spent:** _Pending_  

**Notes:**  
_Implementation notes will be added by Dev Agent during execution._

---

## QA Results

**Tested By:** _Pending_  
**Test Date:** _Pending_  
**Status:** _Pending_  

**Test Results:**  
_QA validation results will be added after implementation._
