name: Copilot Auto-Repair
on:
    workflow_run:
        workflows: ["Run Tests"] # Name of your main test workflow
        types:
            - completed
    workflow_dispatch:
        inputs:
            test_run_id:
                description: "Test workflow run ID (leave empty to use latest failed run)"
                required: false
                type: string

permissions:
    issues: write
    contents: read
    actions: read

jobs:
    report-failure:
        if: ${{ github.event.workflow_run.conclusion == 'failure' || github.event_name == 'workflow_dispatch' }}
        runs-on: ubuntu-latest
        steps:
            - name: Download Test Logs
              run: |
                  RUN_ID="${{ inputs.test_run_id || github.event.workflow_run.id }}"
                  gh run view $RUN_ID --log-failed > error_log.txt || echo "No logs available for run $RUN_ID"
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Create Issue for Copilot
              uses: dacbd/create-issue-action@v2
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  title: "ðŸš¨ Automated Test Failure: Run ${{ github.event.workflow_run.id }}"
                  body: |
                      The CI build failed. Please analyze the following error logs and open a Pull Request to fix the failing tests.

                      **Error Logs:**
                      ```
                      $(cat error_log.txt | tail -n 50) 
                      ```
                  assignees: copilot # Assigning to Copilot triggers the Agent
